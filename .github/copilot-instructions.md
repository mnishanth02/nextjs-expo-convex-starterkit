# Copilot Instructions

## Architecture Overview

This is a Turborepo monorepo with a unified full-stack architecture:

- **`apps/web/`** - Next.js 16 App Router with React 19, Tailwind CSS 4
- **`apps/native/`** - Expo 54 mobile app (React Native 0.81) with typed routes enabled
- **`packages/backend/`** - Convex serverless backend (real-time database + functions)
- **`packages/web-ui/`** - Radix UI component library for web (50+ components)
- **`packages/types/`** - Shared TypeScript types (zero runtime dependencies)
- **`packages/utils/`** - Shared utilities (error parsing, ID generation)
- **`packages/config/`** - Shared TSConfig presets

**Key Integration:** Both apps consume the same Convex backend via `@repo/backend` workspace dependency. Authentication flows through Better Auth → Convex → React providers.

## Development Workflow

### Starting Development

```bash
# Full stack (all apps + backend)
pnpm dev

# Individual apps (recommended for focused work)
pnpm dev:web       # Next.js on :3000
pnpm dev:native    # Expo with metro bundler
pnpm dev:server    # Convex backend only
```

**First-time setup:** Run `pnpm dev:setup` to configure Convex and create `packages/backend/.env.local` with deployment credentials.

### Environment Variables Setup

Apps require separate `.env.local` files copied from `.env.example`:

**Web** (`apps/web/.env.local`):
```bash
NEXT_PUBLIC_CONVEX_URL=https://your-deployment.convex.cloud
NEXT_PUBLIC_CONVEX_SITE_URL=https://your-deployment.convex.site
```

**Native** (`apps/native/.env.local`):
```bash
EXPO_PUBLIC_CONVEX_URL=https://your-deployment.convex.cloud
EXPO_PUBLIC_CONVEX_SITE_URL=https://your-deployment.convex.site
```

**Backend** (`packages/backend/.env.local` - auto-generated by `pnpm dev:setup`):
```bash
CONVEX_DEPLOYMENT=dev:your-deployment
CONVEX_SITE_URL=https://your-deployment.convex.site
```

Get deployment URLs from Convex dashboard or `packages/backend/.env.local` after running setup.

## Convex Backend Architecture

### File Structure

Backend code lives in `packages/backend/convex/`:
- **`auth.ts`** - Better Auth configuration with `createAuth()` and `authComponent`
- **`auth.config.ts`** - Better Auth provider config (enables Convex domain)
- **`convex.config.ts`** - Mounts Better Auth component via `defineApp()`
- **`http.ts`** - HTTP router with `authComponent.registerRoutes()`
- **`users.ts`** - User-related mutations/queries
- **`healthCheck.ts`** - Example query endpoint
- **`_generated/`** - Auto-generated (never edit manually)

### Writing Convex Functions

Convex functions must be **pure** - no Node.js APIs, no file system access:

```typescript
import { query, mutation } from "./_generated/server"
import { v } from "convex/values"

// Query (read-only)
export const get = query({
  args: { id: v.id("users") },
  handler: async (ctx, args) => {
    return ctx.db.get(args.id)
  },
})

// Mutation (writes)
export const create = mutation({
  args: { name: v.string(), email: v.string() },
  handler: async (ctx, args) => {
    return ctx.db.insert("users", args)
  },
})
```

**Authentication in functions:**
```typescript
import { authComponent } from "./auth"

export const getCurrentUser = query({
  args: {},
  handler: async (ctx) => {
    return authComponent.getAuthUser(ctx) // Returns user or null
  },
})
```

**Database:** Schema is inferred from mutations - no migrations. Access via `ctx.db.query()`, `ctx.db.insert()`, `ctx.db.patch()`, `ctx.db.delete()`.

## Authentication Pattern (Better Auth + Convex)

### Architecture Flow

1. **Backend Setup** (`packages/backend/convex/auth.ts`):
   - `createAuth()` configures Better Auth with Convex adapter
   - `authComponent = createClient<DataModel>(components.betterAuth)` provides helpers
   - Email/password enabled (`requireEmailVerification: false` for dev)
   - Social providers: Google, Apple (configure with env vars)
   - `trustedOrigins` includes `native://` scheme for Expo

2. **HTTP Routes** (`packages/backend/convex/http.ts`):
   ```typescript
   authComponent.registerRoutes(http, createAuth)
   ```
   Exposes endpoints like `/auth/sign-in`, `/auth/sign-up` at `convex.site` URL

3. **Web App Integration:**
   - **Client** (`apps/web/lib/auth/client.ts`): `authClient = createAuthClient({ plugins: [convexClient()] })`
   - **Server** (`apps/web/lib/auth-server.ts`): `getToken()` for server components
   - **Provider** (`apps/web/components/providers/convex-client-provider.tsx`): Wraps app with `ConvexBetterAuthProvider`
   - **API Route** (`apps/web/app/api/auth/[...all]/route.ts`): `nextJsHandler()` proxies auth requests

4. **Native App Integration:**
   - **Client** (`apps/native/lib/auth/client.ts`): Uses `expoClient()` plugin with SecureStore
   - **Provider** (`apps/native/components/providers/convex-client-provider.tsx`): Same `ConvexBetterAuthProvider`
   - **Hooks** (`apps/native/lib/auth/hooks/`): `useSignIn()`, `useSignUp()`, `useLogout()`
   - **Schemas** (`apps/native/lib/schemas/auth.ts`): Zod validation with password requirements

### Getting Authenticated User

```typescript
import { useQuery } from "convex/react"
import { api } from "@repo/backend/convex/_generated/api"

const user = useQuery(api.auth.getCurrentUser)
if (user) {
  // User is authenticated
}
```

**Important:** Both apps use `expectAuth: false` in `ConvexReactClient` to allow Better Auth to manage auth state progressively.

## Shared Packages Pattern

### `@repo/types` - Shared TypeScript Types

Framework-agnostic types with zero runtime dependencies:
```typescript
import type { SignInCredentials, AuthState, AuthErrorCode } from "@repo/types"
```

Exports: `AuthState`, `SignInCredentials`, `SignUpData`, `OAuthProvider`, `AuthError`, `AuthErrorCode`

### `@repo/utils` - Shared Utilities

Framework-agnostic utilities:
```typescript
import { parseAuthError, getAuthErrorMessage } from "@repo/utils/errors"
import { generateUniqueId } from "@repo/utils/id"

// Parse Better Auth errors into user-friendly messages
const { error, code } = parseAuthError(response.error)
```

### `@repo/webui` - Web Component Library

Radix UI components with Tailwind CSS 4 (50+ components):
```typescript
import { Button } from "@repo/webui/components/button"
import { Input } from "@repo/webui/components/input"
import { Card } from "@repo/webui/components/card"
```

Built with: Radix UI primitives, `class-variance-authority`, `tailwind-merge`, React Hook Form integration

## Code Style & Formatting

Uses **Biome** (not ESLint/Prettier):

```bash
pnpm format  # Auto-format all files
pnpm check   # Lint + format with auto-fix
```

**Biome conventions from `biome.json`:**
- Double quotes, semicolons as needed, trailing commas ES5-style
- Import types: **enforce** `import type { Foo } from 'bar'` (error level)
- Node.js imports: **enforce** `node:` protocol (error level)
- Tailwind class sorting: enabled with `cn()`, `clsx()`, `cva()` functions
- 100 character line width
- Excludes: `convex/_generated/**` from all checks
- `useExhaustiveDependencies`: info level (React hooks)

**Pre-commit hooks:** `lint-staged` runs Biome checks automatically via Husky on `*.{js,ts,jsx,tsx,json,jsonc}` files.

## Turborepo Task Dependencies

From `turbo.json`:
- `build` depends on `^build` (builds dependencies first)
- `dev` is persistent and not cached
- Build outputs: `.next/**`, `dist/**`
- Environment files (`.env*`) are included in cache keys

**Filter syntax:** 
```bash
turbo -F web dev              # Run dev only in web workspace
turbo -F @repo/backend dev    # Run dev only in backend
turbo build --filter=native   # Build native app and dependencies
```

## Package Manager

**pnpm** with workspace protocol:
- Dependencies use `workspace:*` to reference internal packages
- Lockfile is `pnpm-lock.yaml`
- Workspaces: `apps/*`, `packages/*`
- Node.js ≥20 required
- React 19 enforced via `resolutions` and `pnpm.overrides`

**Adding dependencies:**
```bash
pnpm add <pkg> -w              # Add to root
pnpm add <pkg> -F web          # Add to web workspace
pnpm add <pkg> -F @repo/types  # Add to types package
```

## Native App Specifics

### Expo Configuration

- **Scheme:** `native://` for deep linking (configured in `app.json`)
- **New Architecture:** Enabled (`newArchEnabled: true`)
- **Typed Routes:** Enabled (`experiments.typedRoutes: true`)
- **React Compiler:** Enabled (`experiments.reactCompiler: true`)

### Authentication Flow

1. Root layout checks auth state via `useAuthState()` hook
2. Unauthenticated users redirected to `(auth)/sign-in`
3. Sign-in/sign-up use React Hook Form + Zod validation
4. Success shows Toast notification and navigates to `(tabs)`
5. Sessions persist via Expo SecureStore (Better Auth integration)

### Form Validation

Password requirements (defined in `apps/native/lib/schemas/auth.ts`):
- Minimum 8 characters
- At least one uppercase letter
- At least one lowercase letter  
- At least one number

## Common Gotchas

1. **Convex functions must be in `packages/backend/convex/`** - nested folders ok, but outside this directory won't work
2. **React 19 is enforced** - check component compatibility before adding dependencies
3. **Next.js uses App Router only** - no pages directory support
4. **Biome, not Prettier** - don't add Prettier configs
5. **Convex auth requires both client and server setup** - missing either breaks auth flow
6. **Environment variables differ between apps** - `NEXT_PUBLIC_*` vs `EXPO_PUBLIC_*`
7. **`expectAuth: false` required** - Better Auth manages authentication state, not ConvexReactClient
8. **Native app scheme** - Must match `app.json` scheme for deep linking to work
9. **Better Auth endpoint** - Use `.convex.site` URL (not `.convex.cloud`) for auth requests

## File Naming Conventions

- **Components:** PascalCase with `.tsx` extension (`AuthButton.tsx`)
- **Utilities:** kebab-case with `.ts` extension (`parse-auth-error.ts`)
- **Convex functions:** camelCase with `.ts` extension (`healthCheck.ts`)
- **Next.js routes:** `page.tsx`, `layout.tsx`, `route.ts`, `loading.tsx`, `error.tsx`
- **Expo routes:** File-based routing (`apps/native/app/`) with `_layout.tsx` for layouts

## Debugging

**Convex logs:**
```bash
# View logs in dashboard at https://dashboard.convex.dev
# Or tail logs in terminal:
npx convex logs --tail
```

**Check auth state:**
```typescript
// In browser console or React DevTools
authClient.getSession() // Returns { user, session } or null
```

**Common issues:**
- Missing env vars: Check `.env.local` files exist and match `.env.example`
- Auth not working: Verify `CONVEX_SITE_URL` matches between backend and apps
- Convex function errors: Check browser Network tab for function responses
- Expo auth issues: Clear app data/reinstall if SecureStore gets corrupted
